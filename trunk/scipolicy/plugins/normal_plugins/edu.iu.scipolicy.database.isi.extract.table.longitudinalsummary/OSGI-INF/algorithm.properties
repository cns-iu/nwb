menu_path=Extract/From ISI Database/start
label=Extract Longitudinal Summary
description=Provides a per-year summary of a variety of figures
in_data=db:isi
out_data=prefuse.data.Table
service.pid=edu.iu.scipolicy.database.isi.extract.table.longitudinalsummary
remoteable=true

query = \
SELECT   yrs.yr, \n\
         Coalesce(c_documents.documents_published, 0)            AS documents_published, \n\
         Coalesce(c_refs_in.references_published, 0)             AS references_published, \n\
         Coalesce(c_refs_out.total_references_made, 0)           AS total_references_made, \n\
         Coalesce(c_refs_out.distinct_references_made, 0)        AS distinct_references_made, \n\
         Coalesce(c_authors.distinct_authors, 0)                 AS distinct_authors, \n\
         Coalesce(c_sources.distinct_sources, 0)                 AS distinct_sources, \n\
         Coalesce(c_author_keywords.distinct_author_keywords, 0) AS distinct_author_keywords, \n\
         Coalesce(c_isi_keywords.distinct_isi_keywords, 0)       AS distinct_isi_keywords, \n\
         Coalesce(c_other_keywords.distinct_other_keywords, 0)   AS distinct_other_keywords \n\
FROM     -- Consider each publication year and each referenced year. \n\
         (SELECT publication_year AS yr \n\
          FROM   document \n\
          WHERE  publication_year IS NOT NULL \n\
          UNION \n\
          SELECT reference_year AS yr \n\
          FROM   reference \n\
          WHERE  reference_year IS NOT NULL) AS yrs \n\
 \n\
         -- How many documents were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year AS yr, \n\
		                     Count(d.pk)        AS documents_published \n\
					FROM     document d \n\
					GROUP BY d.publication_year) AS c_documents \n\
			--DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_documents.yr) \n\
 \n\
         -- How many documents referred to this year? \n\
         LEFT JOIN (SELECT   r.reference_year AS yr, \n\
                             Count(r.pk)      AS references_published \n\
                    FROM     reference r \n\
                    GROUP BY r.reference_year) AS c_refs_in \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_refs_in.yr) \n\
 \n\
         -- How many references were made this year? \n\
         LEFT JOIN (SELECT   d.publication_year   AS yr, \n\
                             Count(r.pk)          AS total_references_made, \n\
                             Count(DISTINCT r.pk) AS distinct_references_made \n\
                    FROM     document d \n\
                             JOIN cited_references cr \n\
                               ON (d.pk = cr.cited_references_document_fk) \n\
                             JOIN reference r \n\
                               ON (cr.cited_references_reference_fk = r.pk) \n\
                    GROUP BY d.publication_year) AS c_refs_out \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_refs_out.yr) \n\
 \n\
         -- How many authors were there among the documents that were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year                  AS yr, \n\
                             Count(DISTINCT a.authors_person_fk) AS distinct_authors \n\
                    FROM     document d \n\
                             JOIN authors a \n\
                               ON (d.pk = a.authors_document_fk) \n\
                    GROUP BY d.publication_year) AS c_authors \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_authors.yr) \n\
 \n\
         -- How many sources were there among the documents that were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year   AS yr, \n\
                             Count(DISTINCT s.pk) AS distinct_sources \n\
                    FROM     document d \n\
                             JOIN source s \n\
                               ON (d.document_source_fk = s.pk) \n\
                    GROUP BY d.publication_year) AS c_sources \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_sources.yr) \n\
 \n\
 \n\
         -- ============ KEYWORDS ============ \n\
         -- How many author-provided keywords were there \n\
		 --   among the documents that were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year   AS yr, \n\
                             Count(DISTINCT k.pk) AS distinct_author_keywords \n\
                    FROM     document d \n\
                             JOIN document_keywords dk \n\
                               ON (d.pk = dk.document_keywords_document_fk) \n\
                             JOIN keyword k \n\
                               ON (dk.document_keywords_keyword_fk = k.pk) \n\
                    WHERE    k.type = 'authorKeywords' \n\
                    GROUP BY d.publication_year) AS c_author_keywords \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_author_keywords.yr) \n\
 \n\
         -- How many ISI-provided keywords were there \n\
		 --   among the documents that were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year   AS yr, \n\
                             Count(DISTINCT k.pk) AS distinct_isi_keywords \n\
                    FROM     document d \n\
                             JOIN document_keywords dk \n\
                               ON (d.pk = dk.document_keywords_document_fk) \n\
                             JOIN keyword k \n\
                               ON (dk.document_keywords_keyword_fk = k.pk) \n\
                    WHERE    k.type = 'keywordsPlus' \n\
                    GROUP BY d.publication_year) AS c_isi_keywords \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_isi_keywords.yr) \n\
 \n\
         -- How many keywords (beyond those provided by the author or ISI) \n\
         --   were there among the documents that were published this year? \n\
         LEFT JOIN (SELECT   d.publication_year   AS yr, \n\
                             Count(DISTINCT k.pk) AS distinct_other_keywords \n\
                    FROM     document d \n\
                             JOIN document_keywords dk \n\
                               ON (d.pk = dk.document_keywords_document_fk) \n\
                             JOIN keyword k \n\
                               ON (dk.document_keywords_keyword_fk = k.pk) \n\
                    WHERE    k.type <> 'authorKeywords' \n\
                             AND k.type <> 'keywordsPlus' \n\
                    GROUP BY d.publication_year) AS c_other_keywords \n\
           --DERBY-PROPERTIES joinStrategy=HASH \n\
           ON (yrs.yr = c_other_keywords.yr) \n\
GROUP BY yrs.yr, \n\
         c_documents.documents_published, \n\
         c_refs_in.references_published, \n\
         c_refs_out.distinct_references_made, \n\
         c_refs_out.total_references_made, \n\
         c_authors.distinct_authors, \n\
         c_sources.distinct_sources, \n\
         c_author_keywords.distinct_author_keywords, \n\
         c_isi_keywords.distinct_isi_keywords, \n\
         c_other_keywords.distinct_other_keywords \n\
ORDER BY yrs.yr

output_label=Longitudinal Summary
documentation_url=https://nwb.slis.indiana.edu/community/?n=Sci2Algorithm.ISIExtractLongitudinalSummary