<?xml version="1.0" encoding="UTF-8"?>
<project name="addAntBuiltPlugins" default="build">
	<property name="input.dir" relative="true">${basedir}/target/products</property>
	<property name="output.dir" relative="true">${basedir}/target/products-final</property>
	<property name="deploy.dir" relative="false">/projects/nwb/www/htdocs/nightly/sci2</property>

	<target name="build">
		<taskdef resource="net/sf/antcontrib/antcontrib.properties" />
		<delete dir="${output.dir}" />
		<mkdir dir="${output.dir}" />

		<foreach target="each-product-zip" param="product.zip">
			<path>
				<fileset dir="${input.dir}" includes="*.zip" />
			</path>
		</foreach>
	</target>
	
	<target name="deploy">
		<tstamp/>
		<copy todir="${deploy.dir}/${product.version}.${DSTAMP}${TSTAMP}">
			<fileset dir="${output.dir}"></fileset>
		</copy>
	</target>

	<target name="each-product-zip">
		<basename property="product.filename" file="${product.zip}" />
		<property name="product.zip.out">${output.dir}/${product.filename}</property>
		<echo>Going to use ${product.zip} to make ${product.zip.out}</echo>

		<tempfile property="temp.dir" />
		<mkdir dir="${temp.dir}" />

		<unzip src="${product.zip}" dest="${temp.dir}">
			<patternset>
				<include name="**/configuration/config.ini" />
			</patternset>
		</unzip>

		<!-- Tycho / Eclipse don't honor this option if you set it to true in the .product definition file.  You have to change it after the fact.  *pout* -->
		<replaceregexp match="org\.eclipse\.update\.reconcile=false" replace="org\.eclipse\.update\.reconcile=true">
			<fileset dir="${temp.dir}" includes="**/configuration/config.ini" />
		</replaceregexp>

		<zip destfile="${product.zip.out}" duplicate="fail">
			<zipfileset src="${product.zip}" excludes="**/configuration/config.ini" />
			<zipfileset dir="../../../ant-parent/plugins" erroronmissingdir="true" includesfile="sci2-nonpde-plugins.txt" prefix="plugins" />
			<zipfileset dir="${temp.dir}" includes="**/*.ini" />
		</zip>
		<delete dir="${temp.dir}" />
	</target>
</project>