{% extends "core/bases/simple_base.html" %}
{% block nav %}
  <div id="nav">
    {% load core_templatetags %}
    {% nav_bar 'Upload' %}
  </div>
{% endblock %}{# block nav #}
{% block scripts_header %}
	{{ block.super }}
	<script type="text/javascript" src="/core_media/javascript/image_swap.js"></script>
{% endblock %}

{% block content %}
<h1>Upload Your Data</h1>
<form enctype="multipart/form-data" action="{% url datasets.views.create_dataset %}" method="POST">
    <table class="form">
        {% load core_templatetags %}
        {% include_form_as_table form 'True' %}
  		{{ ref_formset.as_table }}
    </table>
	{% load geoloc_templatetags%}
	{% add_locations_map_for_dataset geoloc_add_formset geoloc_remove_formset %}
    <input type="image" alt="Submit New Dataset" src="/core_media/images/submit.jpg" value="Upload" />
</form>

<script type="text/javascript">

var formPrefix = 'reference';

var referenceRows = [];

initialize();

function initialize(){
	initializeReferences();
	insertAddButton();
}

// Fills 'referenceRows' array, and adds 'remove' links to all but the first reference row.
function initializeReferences(){
	var numRefs = getReferenceCount();
	for(i = 0; i < numRefs; i++){
		var referenceToAdd = document.getElementById('id_' + formPrefix + '-' + i + '-' + formPrefix);
		var td = referenceToAdd.parentNode;
		var tr = td.parentNode;
		
		if (i != 0) {
			//(The first reference doesn't need a 'remove' link)
			var removeLink = createRemoveLink(referenceToAdd.id)
			td.appendChild(removeLink);
		}
		
		referenceRows[i] = tr;
	}
}
function getReferenceCount(){
	var manager = getManager();
	return manager.value;
}
// The manager keeps track of how many reference inputs we have.
function getManager(){
	var manager = document.getElementById('id_' + formPrefix + '-TOTAL_FORMS');
	return manager;
}
function insertAddButton(){
	var insertionPoint = getInsertionPoint();

	addLink = document.createElement('a');
	addLink.setAttribute('onclick', 'addReference(); return false;');
	addLink.innerHTML = 'Add More';
	insertionPoint.parentNode.insertBefore(addLink, insertionPoint.nextSibling);	
}
function getInsertionPoint(){
	var lastReference = document.getElementById('id_' + formPrefix + '-' + parseInt(getReferenceCount() - 1) + '-' + formPrefix).parentNode.parentNode;
	return lastReference;
}
function addReference(){

	// Create the reference.
	
	var newReferenceID = getReferenceCount();
	
	var labelToAdd = createReferenceLabel(newReferenceID);
	var referenceToAdd = createReference(formPrefix, newReferenceID, '');
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	var td = document.createElement('td');
	var removeLink = createRemoveLink(referenceToAdd.id);

	//(Put the new tr into the ref array as the last position)
	referenceRows[getReferenceCount()] = tr;
	
	tr.appendChild(th);
	th.appendChild(labelToAdd);

	tr.appendChild(td);
	td.appendChild(referenceToAdd);
	td.appendChild(removeLink);
	
	// Add the reference to the DOM.

	var insertionPoint = getInsertionPoint();
	insertionPoint.parentNode.insertBefore(tr, insertionPoint.nextSibling);

	//Update the manager to reflect the added reference
	
	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) + 1);
}
function createReferenceLabel(formNumber){
	var label = document.createElement('label');

	label.setAttribute('for', 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix);
	label.innerHTML = 'Reference:';

	return label;
}
function createReference(formPrefix, formNumber, formValue){
	var id = 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix;
	var value = formValue;
	var name = formPrefix + '-' + formNumber + '-' + formPrefix;
	var reference = document.createElement('input');

	reference.setAttribute('type', 'text');
	reference.setAttribute('id', id);
	reference.setAttribute('value', value);
	reference.setAttribute('name', name);

	return reference;
}
function createRemoveLink(id){
	var removeLink = document.createElement('a');

	removeLink.setAttribute('onclick', 'removeReference("' + id + '"); return false;');
	removeLink.innerHTML = 'Remove';

	return removeLink;
}
function removeReference(id){
	// Find the reference.
	
	var referenceToRemove = document.getElementById(id);
	var td = referenceToRemove.parentNode;
	var tr = td.parentNode;
	var tbody = tr.parentNode;

	// Remove the reference from the DOM.
	
	tbody.removeChild(tr);

	// Update the manager to reflect the removal.
	
	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) - 1);
	
	// Remove referenceRow from referenceRows.
	
	var numRefs = getReferenceCount();
	for(var i = 1; i < numRefs; i++){
		if(referenceRows[i] == tr){
			referenceRows[i] = null;
		}
	}
	
	// Renumber the remaining rows.
	
	updateReferenceRows();
}

// Renumber the rows so their ids are increment
function updateReferenceRows(){
	/*
	** Drop out all the null elements.
	**/
	var count = referenceRows.length;
	for(var i = 1; i < count; i++){
		if(referenceRows[i] == null){
			referenceRows.splice(i,1);
		}
	}
	/*
	** Set the ids for the inputs and the remove links
	**   based on their position in the array so all
	**   the ids are in order for the formset.
	*/
	count = referenceRows.length;
	for(var i = 1; i < count; i++){
		// the tr had two children if correctly formed - [0] is the 'input', [1] is the 'a'
		var input = referenceRows[i].childNodes[1].childNodes[0];

		input.id = 'id_' + formPrefix + '-' + i + '-' + formPrefix;
		input.name = formPrefix + '-' + i + '-' + formPrefix;

		var removeLink = referenceRows[i].childNodes[1].childNodes[1];

		removeLink.setAttribute('onclick', 'removeReference("' + input.id + '"); return false;');
	}
}
</script>
{% endblock %}