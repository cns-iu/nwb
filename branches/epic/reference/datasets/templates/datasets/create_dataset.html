{% extends "core/bases/simple_base.html" %}
{% block nav %}
  <div id="nav">
    {% load core_templatetags %}
    {% nav_bar 'Upload' %}
  </div>
{% endblock %}{# block nav #}
{% block scripts_header %}
	{{ block.super }}
	<script type="text/javascript" src="/core_media/scripts/image_swap.js"></script>
{% endblock %}

{% block content %}
<h1>Upload Your Data</h1>
<form enctype="multipart/form-data" action="{% url datasets.views.create_dataset %}" method="POST">
    <table class="form">
        {% load core_templatetags %}
        {% include_form_as_table form 'True' %}
  		{{ ref_formset.as_table }}
    </table>
	{% load geoloc_templatetags%}
	{% add_locations_map_for_dataset add_formset remove_formset %}
    <input type="image" alt="Submit New Dataset" src="/core_media/images/submit.jpg" value="Upload" />
</form>

<script type="text/javascript">
var formPrefix = 'reference';
var last_id;
var references = [];

initalize();

function initalize(){
	last_id = getCount();
	initalizeReferences();
	insertAddButton();
}
function getCount(){
	var manager = getManager();
	return manager.value - 1;
}
function getManager(){
	var manager = document.getElementById('id_' + formPrefix + '-TOTAL_FORMS');
	return manager;
}
function initalizeReferences(){
	var count = getCount();
	for(i = 0; i < count; i++){
		var input = document.getElementById('id_' + formPrefix + '-' + i + '-' + formPrefix);
		var tr
		references[i] = form;
	}
}
function insertAddButton(){
	var insertionPoint = getInsertionPoint();

	addLink = document.createElement('a');
	addLink.setAttribute('onclick', 'addReference(); return false;');
	addLink.innerHTML = 'Add More';
	insertionPoint.parentNode.insertBefore(addLink, insertionPoint.nextSibling);	
}
function getInsertionPoint(){
	var insertionPoint = document.getElementById('id_' + formPrefix + '-' + last_id + '-' + formPrefix).parentNode.parentNode;
	return insertionPoint;
}
function addReference(){
	var newReferenceNumber = last_id + 1;
	var insertionPoint = getInsertionPoint();
	var labelToAdd = createReferenceLabel(newReferenceNumber);
	var referenceToAdd = createReference(formPrefix, newReferenceNumber, '');
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	var td = document.createElement('td');
	var removeLink = createRemoveLink(referenceToAdd.id);

	tr.appendChild(th);
	th.appendChild(labelToAdd);

	tr.appendChild(td);
	td.appendChild(referenceToAdd);
	td.appendChild(removeLink);

	insertionPoint.parentNode.insertBefore(tr, insertionPoint.nextSibling);

	last_id ++;
	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) + 1);
}
function createReferenceLabel(formNumber){
	var label = document.createElement('label');

	label.setAttribute('for', 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix);
	label.innerHTML = 'Reference:';

	return label;
}
function createReference(formPrefix, formNumber, formValue){
	var id = 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix;
	var value = formValue;
	var name = formPrefix + '-' + formNumber + '-' + formPrefix;
	var reference = document.createElement('input');

	reference.setAttribute('type', 'text');
	reference.setAttribute('id', id);
	reference.setAttribute('value', value);
	reference.setAttribute('name', name);

	return reference;
}
function createRemoveLink(id){
	var removeLink = document.createElement('a');

	removeLink.setAttribute('onclick', 'removeReference("'+id+'"); return false;');
	removeLink.innerHTML = 'Remove';

	return removeLink;
}
function removeReference(id){
	var referenceToRemove = document.getElementById(id);
	var td = referenceToRemove.parentNode;
	var tr = td.parentNode;
	var tbody = tr.parentNode;
	tbody.removeChild(tr);

	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) - 1);
}
</script>
{% endblock %}