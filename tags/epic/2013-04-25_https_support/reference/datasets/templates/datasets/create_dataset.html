{% extends "core/bases/simple_base.html" %}
{% block nav %}
  <div id="nav">
    {% load core_templatetags %}
    {% nav_bar 'Upload' %}
  </div>
{% endblock %}{# block nav #}
{% block scripts_header %}
	{{ block.super }}
	<script type="text/javascript" src="/core_media/scripts/image_swap.js"></script>
{% endblock %}

{% block content %}
<h1>Upload Your Data</h1>
<form enctype="multipart/form-data" action="{% url datasets.views.create_dataset %}" method="POST">
    <table class="form">
        {% load core_templatetags %}
        {% include_form_as_table form 'True' %}
  		{{ ref_formset.as_table }}
    </table>
	{% load geoloc_templatetags%}
	{% add_locations_map_for_dataset add_formset remove_formset %}
    <input type="image" alt="Submit New Dataset" src="/core_media/images/submit.jpg" value="Upload" />
</form>

<script type="text/javascript">
var formPrefix = 'reference';
// This array will store all the tr elements for the references.
var references = [];

initalize();

function initalize(){
	initalizeReferences();
	insertAddButton();
}
function getCount(){
	var manager = getManager();
	return manager.value;
}
function getManager(){
	var manager = document.getElementById('id_' + formPrefix + '-TOTAL_FORMS');
	return manager;
}
function initalizeReferences(){
	var count = getCount();
	for(i = 1; i < count; i++){
		var referenceToAdd = document.getElementById('id_' + formPrefix + '-' + i + '-' + formPrefix);
		var td = referenceToAdd.parentNode;
		var tr = td.parentNode;
		var removeLink = createRemoveLink(referenceToAdd.id)
		
		td.appendChild(removeLink);
		references[i] = tr;
	}
}
function insertAddButton(){
	var insertionPoint = getInsertionPoint();

	addLink = document.createElement('a');
	addLink.setAttribute('onclick', 'addReference(); return false;');
	addLink.innerHTML = 'Add More';
	insertionPoint.parentNode.insertBefore(addLink, insertionPoint.nextSibling);	
}
function getInsertionPoint(){
	var insertionPoint = document.getElementById('id_' + formPrefix + '-' + parseInt(getCount() - 1) + '-' + formPrefix).parentNode.parentNode;
	return insertionPoint;
}
function addReference(){
	var newReferenceNumber = getCount();
	var insertionPoint = getInsertionPoint();
	var labelToAdd = createReferenceLabel(newReferenceNumber);
	var referenceToAdd = createReference(formPrefix, newReferenceNumber, '');
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	var td = document.createElement('td');
	var removeLink = createRemoveLink(referenceToAdd.id);

	//Put the new tr into the ref array as the last position
	references[getCount()] = tr;
	
	tr.appendChild(th);
	th.appendChild(labelToAdd);

	tr.appendChild(td);
	td.appendChild(referenceToAdd);
	td.appendChild(removeLink);

	insertionPoint.parentNode.insertBefore(tr, insertionPoint.nextSibling);

	//Update the manager to reflect the added element
	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) + 1);
}
function createReferenceLabel(formNumber){
	var label = document.createElement('label');

	label.setAttribute('for', 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix);
	label.innerHTML = 'Reference:';

	return label;
}
function createReference(formPrefix, formNumber, formValue){
	var id = 'id_' + formPrefix + '-' + formNumber + '-' + formPrefix;
	var value = formValue;
	var name = formPrefix + '-' + formNumber + '-' + formPrefix;
	var reference = document.createElement('input');

	reference.setAttribute('type', 'text');
	reference.setAttribute('id', id);
	reference.setAttribute('value', value);
	reference.setAttribute('name', name);

	return reference;
}
function createRemoveLink(id){
	var removeLink = document.createElement('a');

	removeLink.setAttribute('onclick', 'removeReference("' + id + '"); return false;');
	removeLink.innerHTML = 'Remove';

	return removeLink;
}
function removeReference(id){
	var referenceToRemove = document.getElementById(id);
	var td = referenceToRemove.parentNode;
	var tr = td.parentNode;
	var tbody = tr.parentNode;

	//Get the entire tr out of the html
	tbody.removeChild(tr);

	//Update the manager to reflect the removal
	var manager = getManager();
	manager.setAttribute('value', parseInt(manager.value) - 1);
	
	var count = getCount();
	for(var i = 1; i < count; i++){
		if(references[i] == tr){
			references[i] = null;
		}
	}

	//Formsets require the numbers to be incremental.
	updateReferences();
}
function updateReferences(){
	/*
	** Drop out all the null elements.
	**/
	var count = references.length;
	for(var i = 1; i < count; i++){
		if(references[i] == null){
			references.splice(i,1);
		}
	}
	/*
	** Set the ids for the inputs and the remove links
	**   based on their position in the array so all
	**   the ids are in order for the formset.
	*/
	count = references.length;
	for(var i = 1; i < count; i++){
		// the tr had two children if correctly formed - [0] is the 'input', [1] is the 'a'
		var input = references[i].childNodes[1].childNodes[0];

		input.id = 'id_' + formPrefix + '-' + i + '-' + formPrefix;
		input.name = formPrefix + '-' + i + '-' + formPrefix;

		var removeLink = references[i].childNodes[1].childNodes[1];

		removeLink.setAttribute('onclick', 'removeReference("' + input.id + '"); return false;');
	}
}
</script>
{% endblock %}